[#US_01]
=== UserStory_01: Client-Registrierung, Authentisierung/Autorisierung und Ressourcen-Anfrage (stationärer Client, OAuth Token Exchange)

Als Nutzer aus dem Kontext LEI möchte ich mich mit meiner SMC-B am Zeta Guard anmelden, um mit dem Fachdienst zu interagieren und geschützte Ressourcen anzufragen.

Diese User Story besteht aus den folgenden Schritten:

* Schritt 1: Registrierung +
( siehe link:{gemSpec_ZETA}#A_27799[A_27799 - ZETA Guard, Client-Registrierung für stationäre Clients] )
* Schritt 2: Authentisierung/Autorisierung +
( siehe link:{gemSpec_ZETA}#A_27800[A_27800 - ZETA Guard, Authentifizierung und Autorisierung für stationäre Clients] )
* Schritt 3: Abfrage Ressource +
( siehe link:{gemSpec_ZETA}#A_27797[A_27797 - ZETA, Ablauf Zugriff auf geschützte Ressource] )

'''

==== Schritt 1: Registrierung

Als Nutzer eines stationären Zeta Clients möchte ich diesen beim Zeta Guard initial registrieren, damit ich anschließend eine erste Aktivierung (Token Exchange) durchführen und den Zeta Client für Anfragen am Zeta Guard verwenden kann.

[mermaid]
....
sequenceDiagram
    participant Client as Zeta Client
    participant Guard as Zeta Guard (PDP Authorization Server)
    participant PDP DB as Zeta Guard (PDP DB)
    autonumber

        activate Client
        Client ->> Client: Generierung des Schlüsselpaars für Registrierung
        Client ->>+ Guard: Registrierungsanfrage
        Guard ->> Guard: Prüfung der Anfrage und Ausstellen von client_id bei Erfolg
        Guard ->>+ PDP DB: Abspeichern der erfolgreichen Registrierung
        PDP DB ->>- Guard:  Speicherbestätigung
        Guard ->>- Client: Registrierungsantwort
        deactivate Client
....

Beschreibung:

. Generierung des Schlüsselpaars für Registrierung: Der Zeta Client generiert ein Schlüsselpaar, bestehend aus einem privaten und einem öffentlichen Schlüssel.

. Registrierungsanfrage: Der Zeta Client übermittelt seine Registrierungsanfrage, inkl. öffentlichem Schlüssel und Metadaten, an den Zeta Guard (Authorization Server/PDP).

. Prüfung der Anfrage und Austellen von client_id bei Erfolg: Der Zeta Guard prüft die Anfrage auf Gültigkeit und Authentizität.
Bei Erfolg wird eine eindeutige client_id für den Zeta Client generiert.

. Abspeichern der erfolgreichen Registrierung: Die erfolgreiche Registrierung wird mit der zugehörigen client_id in der PDP-Datenbank gespeichert.

. Speicherbestätigung: Das erfolgreiche Speichern wird von der PDP-Datenbank bestätigt.

. Registrierungsantwort: Der Zeta Guard sendet dem Zeta Client die Registrierungsantwort mit der vergebenen client_id oder im Fehlerfall eine Fehlermeldung.

===== Akzeptanzkriterien:

* Der Nutzer kann den Registrierungsprozess über den Zeta Client im Kontext der LEI initiieren.
* Nach dem Registrierungsversuch liefert das System eine Rückmeldung über den Status, d.h. erfolgreich oder fehlgeschlagen.
* Verläuft der Registrierungsversuch erfolgreich, so ist der Zeta-Client am Zeta-Guard initial registriert.
* Der Ablauf der Registrierung und Aktivierung ist nachvollziehbar protokolliert, einschließlich Erfolgen und Fehlern.

===== Abgebildet durch folgende Use Cases:

- <<UC_01_01>>
- <<UC_01_06>>
- <<UC_01_07>>
- <<UC_01_08>>
- <<UC_01_09>>

==== Schritt 2: Authentisierung/Autorisierung

Als Nutzer eines stationären Clients möchte ich mich mittels SMC-B am Zeta Guard authentisieren, damit ich anschließend eine Autorisierung für den Zugriff auf eine Ressource erhalte und diese Ressource abfragen kann.

[mermaid]
....
sequenceDiagram
    participant Client as Zeta Client
    participant Guard as Zeta Guard
    autonumber

    Client->>Guard: Authentisierunganfrage mit SMC-B
    Guard->>Client: Authentisierungantwort

    Client->>Guard: Autorisierungsanfrage für Ressource
    Guard->>Client: Autorisierungsantwort
....

Beschreibung:

. Authentisierunganfrage mit SMC-B: Der Zeta Client nutzt die SMC-B, um eine Authentisierungsanfrage zu erstellen und sendet diese an den ZETA Guard.

. Authentisierungsantwort: Der Zeta Guard prüft die Authentisierung und sendet eine Antwort zurück: erfolgreich oder fehlgeschlagen.

. Autorisierungsanfrage für Ressource: Nach erfolgreicher Authentisierung stellt der Zeta Client eine Autorisierungsanfrage für den Zugriff auf eine bestimmte Ressource.

. Autorisierungsantwort: Der Zeta Guard prüft anhand der vorgegebenen Berechtigungsregeln, ob der Zugriff auf die Ressource erlaubt ist und antwortet mit „erlaubt“, wenn der Zugriff erlaubt ist, oder „fehlgeschlagen“, wenn der Zugriff nicht erlaubt ist.
Wenn der Zugriff erlaubt ist, stellt der Zeta Guard ein Zugriffstoken aus.

===== Akzeptanzkriterien:

* Der Nutzer kann mit einer SMC-B am Zeta Guard einen Authentisierungsversuch durchführen.
* Nach dem Authentisierungsversuch liefert das System eine Rückmeldung über den Status, d.h. erfolgreich authentisiert oder fehlgeschlagen.
* Bei einer Autorisierungsanfrage für eine Ressource liefert das System eine eindeutige Entscheidung, d.h. gewährt oder verweigert.
* Der Nutzer erhält eine Rückmeldung, ob er berechtigt ist, die angefragte Ressource zu nutzen oder nicht.

===== Abgebildet durch folgende Use Cases:

- <<UC_01_02>>
- <<UC_01_04>>
- <<UC_01_05>>
- <<UC_01_10>>
- <<UC_01_11>>
- <<UC_01_12>>

==== Schritt 3: Abfrage Ressource

Als Nutzer eines stationären Clients möchte ich mit einer zuvor erlangten Berechtigung eine Ressource vom Fachdienst anfragen, damit ich die Ressource erfolgreich beziehen und weiterverwenden kann.

[mermaid]
....
sequenceDiagram
    participant Client as Zeta Client
    participant Guard as Zeta Guard
    participant Service as Fachdienst
    autonumber

    Client->>Guard: Ressourcenanfrage
    Guard->>Guard: Berechtigungsprüfung

    Guard->>Service: pos. Prüfungsergebnis: Weiterleitung der Anfrage an FD
    Service->>Client: Übermittlung Ressource oder Fehler
....

Beschreibung:

. Ressourcenanfrage: Der Zeta Client stellt beim Zeta Guard eine Anfrage für eine Ressource.

. Berechtigungsprüfung: Der Guard prüft, ob der Client die nötige Berechtigung hat.

. Weiterleitung bei Erfolg: Bei positiver Berechtigungsprüfung leitet der Guard die Anfrage an den Fachdienst weiter.

. Antwort an Zeta Client: Fällt die Berechtigungsprüfung positiv aus, wird die angeforderte Ressource vom Fachdienst bezogen und an den Zeta Client übermittelt.
Bei negativer Berechtigungsprüfung erhält der Zeta Client eine entsprechende Fehlermeldung.

===== Akzeptanzkriterien:

* Der Nutzer verfügt über eine Berechtigung zur Ressourcennutzung, deren Gültigkeit vom System geprüft wird.
* Mit dieser Berechtigung kann eine Anfrage an den Fachdienst gestellt werden.
* Der Fachdienst liefert eine Rückmeldung zur Anfrage (d.h. Ressource erfolgreich zurückgeliefert oder Fehler).

===== Abgebildet durch folgende Use Cases:

- <<UC_01_03>>
- <<UC_01_13>>
- <<UC_01_14>>
- <<UC_01_15>>
- <<UC_01_16>>
- <<UC_01_17>>
- <<UC_01_18>>
- <<UC_01_19>>
- <<UC_01_20>>

'''

==== Identifizierte Use Cases

include::UseCase_01/readme.adoc[]

include::UseCase_02/readme.adoc[]

include::UseCase_03/readme.adoc[]

include::UseCase_04/readme.adoc[]

include::UseCase_05/readme.adoc[]

include::UseCase_06/readme.adoc[]

include::UseCase_07/readme.adoc[]

include::UseCase_08/readme.adoc[]

include::UseCase_09/readme.adoc[]

include::UseCase_10/readme.adoc[]

include::UseCase_11/readme.adoc[]

include::UseCase_12/readme.adoc[]

include::UseCase_13/readme.adoc[]

include::UseCase_14/readme.adoc[]

include::UseCase_15/readme.adoc[]

include::UseCase_16/readme.adoc[]

include::UseCase_17/readme.adoc[]

include::UseCase_18/readme.adoc[]

include::UseCase_19/readme.adoc[]

include::UseCase_20/readme.adoc[]

