# YAML Schema for a PoPP Token according to gematik specification
# Based on gemSpec_PoPP_Service_V1.0.0
$schema: "http://json-schema.org/draft-07/schema#"
title: PoPP Token
description: Schema for a PoPP Token as defined in gematik specification.
type: object
properties:
  header:
    type: object
    description: The JOSE Header of the PoPP-Token.
    properties:
      typ:
        type: string
        const: "vnd.telematik.popp+jwt"
        description: Type of the token.
      alg:
        type: string
        description: The algorithm used to sign the token. Currently only ES256 is supported.
        enum:
          - ES256
      x5c:
        type: array
        description: Contains the certificate chain. The first certificate must be the leaf certificate containing the public key for verifying the signature. It must be base64-der-encoded.
        items:
          type: string
          format: byte # Represents base64 encoded data
        minItems: 1
    required:
      - typ
      - alg
      - x5c
  payload:
    type: object
    description: The JWT Claims Set of the PoPP-Token.
    properties:
      version:
        type: string
        const: "1.0.0"
        description: |
          The version of the PoPP token format.
          - version = "1.0.0": actual value of "version".
      iss:
        type: string
        description: |
          The issuer of the token. The value must be the URL of the
          PoPP server without the path and without a trailing slash.
      iat:
        type: integer
        description: |
          The time the token was issued, interpreted as described in
          https://datatracker.ietf.org/doc/html/rfc7519#section-4.1.6
      proofMethod:
        type: string
        description: |
          The proof method used.
          
          **healthid**:</br>
          "GesundheitsID via PoPP-Modul" i.e., health-ID provided by a
          special mobile app.
          
          **ehc-practitioner-...**:</br>
          Proof by eHC via a client, the client authenticates to the
          PoPP-service by means of an institution ID (i.e., SM-B).
          
          **ehc-provider-...**:</br>
          Proof by eHC via an arbitrary mobile app, the mobile app connects
          directly to the PoPP-service.
          
          **ehc-...-trustedchannel**:</br>
          This is the preferred method of proof for an eHC G2.1, contact-based
          communication.
          The PoPP-service establishes a trusted channel to the eHC and uses
          that channel for (authentically) reading an X.509 certificate.
          
          **ehc-...-cvc-authenticated**:</br>
          This is the only possibly proof method for an eHC G2.1, contactless
          communication.
          The PoPP-service authenticates the eHC and reads the X.509 certificate.
          Because reading the X.509 certificate here is non-authentic (from the
          PoPP-service point of view), the PoPP-service uses a database to check
          if the CV-certificate used for authenticating the eHC corresponds
          to the presented X.509 certificate.
          
          **ehc-...-user-x509**:</br>
          This is the preferred method of proof for an eHC G3.x, contactless
          or contact-based (no eHC PIN involved).
          The PoPP-service uses a challenge-response method where the private
          key corresponding to the X.509 certificate signs the challenge and
          that X.509 contains the information required for PoPP-token
          generation.
          
          **ehc-...-owner-x509**: (backlog, to-be-discussed)</br>
          Same as **ehc-...-user-x509** but another identity from the eHC is
          used where the user is requested to present a PIN.
          This way it is possible to distinguish between the owner of the eHC
          (card-holder) and a user of the eHC (deputy, agent, proxy).
        enum:
          - "healthid"
          - "ehc-practitioner-trustedchannel"
          - "ehc-practitioner-cvc-authenticated"
          - "ehc-practitioner-user-x509"
          - "ehc-practitioner-owner-x509"
          - "ehc-provider-trustedchannel"
          - "ehc-provider-cvc-authenticated"
          - "ehc-provider-user-x509"
          - "ehc-provider-owner-x509"
      patientProofTime:
        type: integer
        description: |
          The time the patient proof was performed, interpreted as described 
          in https://datatracker.ietf.org/doc/html/rfc7519#section-4.1.6
          
          * For proof methods with eHC this is the time the eHC was used.
          * For proof methods with eHealth-ID (GesundheitsID) this is the time
          the identity was verified using OpenID Connect.
      patientId:
        type: string
        description: The patient identifier (KVNR).
      insurerId:
        type: string
        description: The insurer identifier (IKNR).
      actorId:
        type: string
        description: The actor identifier (Telematik-ID).
      actorProfessionOid:
        type: string
        description: Profession OID of the actor.
    required:
      - version
      - iss
      - iat
      - proofMethod
      - patientProofTime
      - patientId
      - insurerId
      - actorId
      - actorProfessionOid
    examples:
      - version: "1.0.0"
        iss: "https://popp.example.com"
        iat: 1722593256
        proofMethod: "ehc-practitioner-trustedchannel"
        patientProofTime: 1722593255
        patientId: "X123456789"
        insurerId: "123456789"
        actorId: "1-2012345678"
        actorProfessionOid: "1.2.276.0.76.4.50"
required:
  - header
  - payload